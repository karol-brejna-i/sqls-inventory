# Data Model (Option B — normalized contact with per-field provenance)

entities:
  - name: School
    fields:
      - { name: id, type: uuid, required: true }
      - { name: name, type: string, required: true }
      - { name: voivodeship, type: string, required: true }
      - { name: region, type: string, required: true, description: "Region within voivodeship (powiat/gmina)" }
      - { name: city, type: string, required: true, description: "City or locality" }
      - { name: street, type: string, required: false }
      - { name: postal_code, type: string, required: false }
      - { name: school_url, type: uri, required: false, description: "School website URL" }
      - { name: pc_url, type: uri, required: false, description: "Parent Council URL" }
      - { name: pc_email, type: email, required: false, description: "Parent Council email" }
      - { name: phone, type: string, required: false, description: "Primary phone number" }
      - { name: facebook_url, type: uri, required: false, description: "Facebook page URL" }
      - { name: insurance_url, type: uri, required: false, description: "Insurance information URL" }
      - { name: school_type, type: string, required: false, description: "Type of school (Primary, Secondary, etc.)" }
      - { name: data_source, type: string, required: true, default: import, description: "Source of the data (import/manual/external)" }
      - { name: created_at, type: timestamp, required: true }
      - { name: updated_at, type: timestamp, required: false }

  - name: SchoolContact
    description: Current contact info per school with per-field provenance
    fields:
      - { name: school_id, type: uuid, required: true, ref: School.id }
      - { name: secretariat_email, type: email, required: false }
      - { name: secretariat_email_source, type: enum(import,manual,external), required: false, default: import }
      - { name: secretariat_email_meta, type: json, required: false, description: "Arbitrary metadata (url, phrase, scraped_at, confidence, etc.)" }
      - { name: secretariat_email_updated_at, type: timestamp, required: false }

      - { name: parents_council_email, type: email, required: false }
      - { name: parents_council_email_source, type: enum(import,manual,external), required: false, default: import }
      - { name: parents_council_email_meta, type: json, required: false }
      - { name: parents_council_email_updated_at, type: timestamp, required: false }

      - { name: phone, type: string, required: false }
      - { name: phone_source, type: enum(import,manual,external), required: false }
      - { name: phone_meta, type: json, required: false }
      - { name: phone_updated_at, type: timestamp, required: false }

      - { name: website, type: uri, required: false }
      - { name: website_source, type: enum(import,manual,external), required: false }
      - { name: website_meta, type: json, required: false }
      - { name: website_updated_at, type: timestamp, required: false }

      - { name: emails, type: email[], required: false, description: "Optional supplemental list; derived or manually curated" }

  - name: ChangeRecord
    description: Append-only audit trail for field-level changes
    fields:
      - { name: id, type: uuid, required: true }
      - { name: school_id, type: uuid, required: true, ref: School.id }
      - { name: field, type: string, required: true, example: "contact.secretariat_email" }
      - { name: old_value, type: json, required: false }
      - { name: new_value, type: json, required: false }
      - { name: source, type: enum(import,manual,external), required: true }
      - { name: meta, type: json, required: false, description: "Snapshot of metadata supplied by the writer" }
      - { name: actor_id, type: string, required: false }
      - { name: client_id, type: string, required: false }
      - { name: timestamp, type: timestamp, required: true }
      - { name: idempotency_key, type: string, required: false, unique: true }

indexes:
  - table: School
    columns: [voivodeship, region, city]
    type: btree
  - table: School
    columns: [name]
    type: gin_trgm
  - table: School
    columns: [school_type, voivodeship]
    type: btree
  - table: School
    columns: [lower(pc_email)]
    type: btree
  - table: School
    columns: [phone]
    type: btree
  - table: ChangeRecord
    columns: [school_id, timestamp]
    type: btree
  - table: ChangeRecord
    columns: [idempotency_key]
    type: btree_unique

validation:
  - emails_must_be_valid_rfc5322: true
  - phone_format_prefer_e164: true
  - website_uri_http_https_only: true
  - region_values_canonical_sets: true

examples:
  school_example:
    id: "00000000-0000-0000-0000-000000000000"
    name: "Szkoła Podstawowa w Kruszynie"
    voivodeship: "łódzkie"
    region: "wieruszowski"
    city: "Bolesławiec"
    school_url: "http://www.szkolawkruszynie.edupage.org"
    pc_url: "https://szkolawkruszynie.edupage.org/a/rada-rodzicow"
    pc_email: "rada.rodzicow.kruszyn@gmail.com"
    insurance_url: "https://szkolawkruszynie.edupage.org/text/?eqa=dGV4dD10ZXh0L3RleHQ3JnN1YnBhZ2U9MQ%3D%3D"
    school_type: "Primary School"
    data_source: "import"
    created_at: "2025-08-25T09:00:00Z"
    secretariat_email_source: "external"
    secretariat_email_meta:
      url: "https://school.edu/contact"
      phrase: "sekretariat"
      scraped_at: "2025-08-21T07:35:00Z"
      confidence: 0.92
    secretariat_email_updated_at: "2025-08-21T07:36:12Z"
    parents_council_email: "parents.council@school.edu"
    parents_council_email_source: "manual"
    parents_council_email_meta:
      note: "Provided by school admin by phone"
    parents_council_email_updated_at: "2025-08-15T10:05:00Z"
    phone: "+48 123 456 789"
    website: "https://school.edu"
    emails:
      - "sekretariat@school.edu"

  change_record_example:
    id: "11111111-1111-1111-1111-111111111111"
    school_id: "00000000-0000-0000-0000-000000000000"
    field: "contact.secretariat_email"
    old_value: "old@school.edu"
    new_value: "sekretariat@school.edu"
    source: "external"
    meta:
      url: "https://school.edu/contact"
      phrase: "sekretariat"
      scraped_at: "2025-08-21T07:35:00Z"
      confidence: 0.92
    client_id: "scraper-mailfinder"
    actor_id: null
    timestamp: "2025-08-21T07:36:12Z"
    idempotency_key: "abc-123"
